{% extends "base.html" %}
{% block body %}
<div id="task-view" class="container">
    <p>
        [[ contextIndex + 1 ]] / [[ contexts.length ]]
    </p>
    <div class="content">
        <template v-for="(context, i) of contexts" v-if="i === contextIndex" :key="i">
            <div v-for="candidateId in candidateIds" :key="candidateId" class="v-padded">
                <div class="v-padded">
                    <h4>Dialog</h4>
                    <vue-markdown :source="context.dialog"></vue-markdown><br />
                    <vue-markdown :source="context.candidates[candidateId]"></vue-markdown>
                </div>
                <div class="v-padded">
                    <h4>Questions</h4>
                    <div class="v-padded" v-for="question in questions" :key="question.id">
                        <p>
                            [[ question.text ]]
                        </p>
                        <div class="buttons has-addons is-left">
                            <span class="button is-static">
                                [[ question.mintext ]]
                            </span>
                            <button 
                                v-for="v in [1, 2, 3, 4, 5]" 
                                :key="v" 
                                class="button"
                                :class="{ 'is-black': isValue(candidateId, question.id, v) }"
                                @click="selectValue(candidateId, question.id, v)"
                            >
                                [[ v ]]
                            </button>
                            <span class="button is-static">
                                [[ question.maxtext ]]
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="v-padded">
                <div class="field is-grouped">
                    <p v-if="contextIndex > 0" class="control">
                        <button class="button is-warn" @click="contextIndex--">
                            ⇦ Previous
                        </button>
                    </p>
                    <p v-if="contextIndex < contexts.length - 1" class="control">
                        <button class="button is-success" @click="contextIndex++">
                            ⇨ Next
                        </button>
                    </p>
                    <p v-else-if="contextIndex === contexts.length - 1" class="control">
                        <button class="button is-success" @click="submit">
                            Submit
                        </button>
                    </p>
                </div>
            </div>
        </template>
    </div>
</div>
<script>
    function loadValue(key) {
        skey = this.__uid__ + '::' + key;
        var value = localStorage.getItem(skey);
        if (value) {
            return JSON.parse(value);
        } else {
            return null;
        }
    }
    function saveValue(key, value) {
        skey = this.__uid__ + '::' + key;
        localStorage.setItem(skey, JSON.stringify(value));
    }
    this.__uid__ = loadValue('uid') || '{{ uid }}';
    this.__contexts__ = loadValue('contexts') || {{ contexts | tojson | safe }};
    this.__questions__ = loadValue('questions') || {{ questions | tojson | safe }};
    saveValue('uid', this.__uid__);
    saveValue('contexts', this.__contexts__);
    saveValue('questions', this.__questions__);
    Vue.use(VueMarkdown);
    var app = new Vue({
        el: '#task-view',
        delimiters: ['[[', ']]'],
        data: {
            uid: this.__uid__,
            contexts: this.__contexts__,
            questions: this.__questions__,
            contextIndex: loadValue('contextIndex') || 0,
            response: loadValue('response') || {},
            candidateIds: [],
        },
        created() {
            this.candidateIds = this.shuffle(Object.keys(this.contexts[this.contextIndex].candidates));
        },
        methods: {
            shuffle(array) {
                let currentIndex = array.length, temporaryValue, randomIndex;
                while(0 !== currentIndex) {
                    randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex -= 1;
                    temporaryValue = array[currentIndex];
                    array[currentIndex] = array[randomIndex];
                    array[randomIndex] = temporaryValue;
                }
                return array;
            },
            isValue(candidateId, questionId, value) {
                const context = this.contexts[this.contextIndex];
                if (!this.response[context.id]) {
                    return false;
                }
                return this.response[context.id][candidateId][questionId] === value;
            },
            selectValue(candidateId, questionId, value) {
                const context = this.contexts[this.contextIndex];
                if (!(context.id in this.response)) {
                    var candidateIds = Object.keys(context.candidates);
                    var contextResponse = {};
                    candidateIds.forEach(cid => {
                        contextResponse[cid] = {};
                        this.questions.forEach(question => {
                            contextResponse[cid][question.id] = null
                        });
                    });
                    Vue.set(this.response, context.id, contextResponse);
                }
                this.response[context.id][candidateId][questionId] = value;
            },
            resetValues() {
                saveValue('uid', null);
                saveValue('contexts', null);
                saveValue('questions', null);
                saveValue('contextIndex', null);
                saveValue('response', null);
            },
            submit() {
                // Validate the response.
                this.contexts.forEach(context => {
                    if (!this.response[context.id]) {
                        alert('You have to answer to all questions.');
                        return;
                    }
                    Object.values(this.response[context.id]).forEach(cvalue => {
                        Object.values(cvalue).forEach(qvalue => {
                            if (qvalue === null) {
                                alert('You have to answer to all questions.');
                                return;
                            }
                        })
                    })
                })
                // Submit with AJAX call.
                axios.post('/tasks/submit', {
                    response: this.response,
                    uid: this.uid,
                }).then(response => {
                    const data = response.data;
                    const succeed = data.startsWith('done:');
                    if (succeed) {
                        const code = data.split(':')[1];
                        window.location.href = '/tasks/done?code=' + encodeURI(code);
                        this.resetValues();
                    } else {
                        alert('Error from server on submit: ' + response);
                    }
                }).catch(function (error) {
                    alert('Error occurred on submit: ' + error);
                });
            },
        },
        watch: {
            contextIndex() {
                this.candidateIds = this.shuffle(Object.keys(this.contexts[this.contextIndex].candidates));
                saveValue('contextIndex', this.contextIndex);
            },
            response() {
                saveValue('response', this.response);
            },
        }
    })
</script>
{% endblock %}